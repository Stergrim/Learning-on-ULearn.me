# Оптимизация сортировки

Индексы используются и для оптимизации выполнения запросов с сортировкой, т.к. хранят данные в упорядоченном виде.

**Сортировка по нескольким колонкам**

В общем случае стоит создать индекс на все колонки, которые участвуют в сортировке. Порядок колонок в индексе **должен совпадать** с порядком колонок в условии ORDER BY.

Например, для запроса `SELECT * FROM table1 ORDER BY f1, f2, f3 LIMIT 10`

В общем случае оптимальным будет индекс `INDEX (f1, f2, f3)`.

Индексы с меньшим количеством колонок тоже могут работать в некоторых ситуациях. Например, для указанного запроса так же работают индексы: INDEX (f1) или INDEX (f1, f2). Индексы с другим набором колонок использоваться не будут.

**Сортировка с указанием направления ASC/DESC**

При создании индекса у каждой колонки в индексе можно указать направление сортировки – ASC или DESC.

Направление сортировки у колонок в индексе должно совпадать с соответствующим направлением сортировки в условии ORDER BY (так же, как и порядок колонок в индексе совпадает с порядком колонок в условии ORDER BY).

Например, для запроса: SELECT * FROM table ORDER BY f1 **DESC** , f2 **ASC** , f3 **DESC**

В общем случае оптимальным будет индекс: INDEX(f1 **DESC** , f2 **ASC** , f3 **DESC**).

**Чтение индекса в обратном порядке**

Т.к. БД может читать индекс в обе стороны, то для примера выше можно было создать индекс, в котором направление сортировки обратное, т.е.

INDEX (f1 **ASC** , f2 **DESC** , f3 **ASC**)

**Дополнительная информация**

[Смотри документацию по использованию индексов в ORDER BY](https://postgrespro.ru/docs/postgresql/13/indexes-ordering).

**Задание**

Выполняй запросы в PGAdmin на демо-базе. Предварительно удали все индексы на таблице bookings.
1. Выбери 100 самых дорогих бронирований (bookings), отсортированных по дате бронирования по возрастанию. Используй только сортировку.
2. Посмотри план запроса.
3. Какой индекс обеспечит максимальную скорость выполнения запроса?
4. Последовательно создай индексы. После каждого проверяй план выполнения запроса: используемые индексы, основной тип доступа к данным, суммарную стоимость.
   - book_date
   - total_amount
   - total_amount ASC, book_date ASC
   - total_amount ASC, book_date DESC
   - total_amount DESC, book_date ASC
5. Какие индексы БД не будет использовать ни при каких условиях? Напиши в первой строке перечень колонок индекса через запятую
6. Какой индекс наиболее оптимальный? В последней строке напиши список колонок индекса через запятую. Указывай ASC/DESC у каждой колонки.

**Все тесты пройдены, задача сдана:**
```pgsql
book_date
total_amount Desc, book_date Asc
```
