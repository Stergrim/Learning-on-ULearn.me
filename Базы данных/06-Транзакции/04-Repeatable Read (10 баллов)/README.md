# Repeatable Read

2017-05-13 проходила акция: при бронировании билетов **больше чем на два** перелета на сумму от **40 000** — скидка 2000. Нужно одним запросом у таких бронирований от 2017-05-13 обновить полную стоимость — вычесть 2000. Чтобы выбрать только те бронирования, у которых больше двух перелетов, нужно использовать подзапрос в условии.

При обновлении мы можем получить несогласованное чтение. Установите у транзакции минимально достаточный уровень изоляции, чтобы при возникновении аномалии мы получали ошибку.

**Примечание 1**

Столбец с датой перелета имеет тип `timestamptz`, поэтому сравнить столбец с '2017-05-13' будет не корректно. Потому что сравнение будет происходить с **'2017-05-13 00:00:00'**.

**Примечание 2**

У каждого билета (таблица `tickets`) может быть несколько перелетов (таблица `ticket_flights`). В подзапросе нужно сделать выборку только тех бронирований билетов, у которых больше двух перелетов.

**Схему необходимых таблиц можно посмотреть на слайде "Транзакция. Всё или ничего".**

**Все тесты пройдены, задача сдана:**
```pgsql
Begin Transaction Isolation Level Repeatable Read;

Update bookings 
Set total_amount = total_amount - 2000
Where book_ref In (
    Select book_ref
    From tickets
    Join ticket_flights Using(ticket_no)
    Group by book_ref
    Having Count(flight_id) > 2
    )
    And book_date >= '2017-05-13 00:00:00+00' 
    And book_date < '2017-05-14 00:00:00+00'
    And total_amount >= 40000;

Commit;
```
