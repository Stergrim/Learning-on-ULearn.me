# Транзакция. Всё или ничего

Пассажир меняет бронь - отказывается от одного билета. Нужно пересчитать полную стоимость брони с номером `305863` и удалить билет с номером `0005432166679`.

**Примечание**

Если произойдет какой-то сбой, не должна возникнуть несогласованность данных. То есть нельзя допустить, чтобы полная стоимость брони не соответствовала билетам пассажира. Поэтому нужно использовать транзакцию.

Таблица bookings

| **Столбец**  | **Тип**       | **Модификаторы** | **Описание**              |
|:-------------|:--------------|:-----------------|:--------------------------|
| book_ref     | char(6)       | not null         | Номер бронирования        |
| book_date    | timestamptz   | not null         | Дата и время бронирования |
| total_amount | numeric(10,2) | not null         | Полная сумма бронирования |

Таблица tickets

| **Столбец** | **Тип**  | **Модификаторы** | **Описание**       |
|:------------|:---------|:-----------------|:-------------------|
| ticket_no   | char(13) | not null         | Номер билета       |
| book_ref    | char(6)  | not null         | Номер бронирования |
| ...         |          |                  |                    |

Таблица ticket_flights

| **Столбец**     | **Тип**       | **Модификаторы** | **Описание**        |
|:----------------|:--------------|:-----------------|:--------------------|
| ticket_no       | char(13)      | not null         | Номер билета        |
| flight_id       | integer       | not null         | Идентификатор рейса |
| fare_conditions | varchar(10)   | not null         | Класс обслуживания  |
| amount          | numeric(10,2) | not null         | Стоимость перелета  |

**Задание**
- В блоке транзакции обнови полную сумму бронирования. Нужно вычесть стоимость перелетов удаляемого билета (используй подзапрос).
- В этом же блоке транзакции попробуй удалить билет из таблице tickets. Транзакция завершится с ошибкой. Что произошло с полной стоимостью бронирования?

**Все тесты пройдены, задача сдана:**
```pgsql
Begin;

Delete From ticket_flights 
Where ticket_no = '0005432166679';

Delete From tickets 
Where ticket_no = '0005432166679' 
  And book_ref = '305863';

Update bookings 
Set total_amount = total_amount - (
    Select Sum(amount)
    From ticket_flights 
    Where ticket_no = '0005432166679'
)
Where book_ref = '305863';

Commit;
```
